<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Next Signal</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
.sintonizado {
  position: relative;
  overflow: hidden;
}

.ondas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  gap: 20px; /* Aumentar el espacio entre barras si son más grandes */
  align-items: center;
  justify-content: center;
  pointer-events: none;
  z-index: 0;
}

.ondas .barra {
  width: 8px; /* Aumentar el ancho de cada barra */
  height: 300px; /* Altura inicial mucho mayor */
  background-color: #ffdfca68;
  border-radius: 4px;
  animation: wave 1.5s ease-in-out infinite alternate;
  animation-play-state: paused;
}

/* Variación de alturas iniciales */
.ondas .barra:nth-child(2) { height: 220px; animation-delay: 0.1s; }
.ondas .barra:nth-child(3) { height: 180px; animation-delay: 0.2s; }
.ondas .barra:nth-child(4) { height: 210px; animation-delay: 0.3s; }
.ondas .barra:nth-child(5) { height: 230px; animation-delay: 0.4s; }
.ondas .barra:nth-child(6) { height: 170px; animation-delay: 0.5s; }
.ondas .barra:nth-child(7) { height: 210px; animation-delay: 0.6s; }
.ondas .barra:nth-child(8) { height: 200px; animation-delay: 0.7s; }
.ondas .barra:nth-child(9) { height: 220px; animation-delay: 0.8s; }
.ondas .barra:nth-child(10) { height: 190px; animation-delay: 0.9s; }
.ondas .barra:nth-child(11) { height: 215px; animation-delay: 1s; }
.ondas .barra:nth-child(12) { height: 175px; animation-delay: 1.1s; }
.ondas .barra:nth-child(13) { height: 205px; animation-delay: 1.2s; }
.ondas .barra:nth-child(14) { height: 225px; animation-delay: 1.3s; }
.ondas .barra:nth-child(15) { height: 180px; animation-delay: 1.4s; }
.ondas .barra:nth-child(16) { height: 210px; animation-delay: 1.5s; }
.ondas .barra:nth-child(17) { height: 200px; animation-delay: 1.6s; }
.ondas .barra:nth-child(18) { height: 220px; animation-delay: 1.7s; }
.ondas .barra:nth-child(19) { height: 190px; animation-delay: 1.8s; }
.ondas .barra:nth-child(20) { height: 215px; animation-delay: 1.9s; }

@keyframes wave {
  from {
    transform: scaleY(0.5);
  }
  to {
    transform: scaleY(1); /* Escala menor para evitar reducir demasiado la altura inicial */
  }
}

.ondas.animate .barra {
  animation-play-state: running;
}

/* Asegura que el contenido esté encima del fondo */
.sintonizado > *:not(.ondas) {
  position: relative;
  z-index: 1;
}

    .icono-radio {
      width:40px;
      height:40px;
      background-color: rgb(255, 235, 199);
      color:orange;
      border-radius:25px;
      margin-right:15px;
      font-size:22px;
      align-content: center;
      padding:5px;
    }
  </style>
</head>
<body>
  <nav class="navbar sticky-top bg-body-tertiary">
    <div class="container">
      <a style="display: flex;flex-direction: row;align-content: center;align-items: center;font-size:28px;" class="navbar-brand user-select-none" href="#">
        <img src="https://nextsuite.es/images/nexticono.png" alt="Logo" width="40" class="d-inline-block align-text-top mr-2">
        <span><strong>Next </strong>Signal</span>
      </a>

      <div class="navbar-text" style="background-color:rgb(213, 255, 213);color:black;padding:5px 15px;border-radius:15px;font-size:18px;">
        <i style="margin-right:10px;" class="fa-solid fa-location-dot"></i><strong>Ciudad</strong>
        </div>
    </div>
  </nav>

  <div class="sintonizado px-4 py-5 text-center bg-light shadow-lg">
    <div class="ondas animate">
      <!-- Crear 20 barras en total -->
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
      <div class="barra"></div>
    </div>
    <p class="lead mb-4">
      Frecuencia sintonizada
    </p>
    <h1 class="display-5 fw-bold">
      <i class="icono-radio fa-solid fa-radio"></i><span id="tuner-element">--</span> FM
    </h1>
    <div class="col-lg-6 mx-auto">
      <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
        <audio id="audio-player text-center" controls autoplay>
          <source src="/api/stream/audio.m3u8" type="application/x-mpegURL">
          <source src="/api/radio/audio.mp3" type="audio/mpeg">
          <source src="/api/radio/audio.ogg" type="audio/ogg">
          <source src="/api/radio/audio.flac" type="audio/flac">
          <source src="/api/radio/audio.aifc" type="audio/aiff">
          <source src="/api/radio/audio.wav" type="audio/wav">
          Tu navegador no soporta el elemento de audio.
        </audio>
        <!--<button type="button" class="btn btn-primary btn-lg px-4 gap-3">Primary button</button>-->
      </div>
    </div>
  </div>

  <div class="container py-4">
    <div class="mb-4">
      <h2>Sintonizador</h2>
      <div>Frecuencia actual: <span id="tuner-element">--</span> MHz</div>
      <form method="POST" action="/api/frequency" id="frequency-form">
        <div class="mt-3">
          <label for="change-freq" class="form-label">Cambiar Frecuencia:</label>
          <input type="range" class="form-range" id="change-freq" name="frequency-slider" min="88" max="108" step="0.1">
          <div>Frecuencia seleccionada: <span id="selected-frequency">--</span> MHz</div>
          <!-- Campo oculto para enviar la frecuencia -->
          <input type="hidden" id="frequency-input" name="frequency" value="">
          <button type="submit" id="tune-button" class="btn btn-primary mt-2" disabled>Sintonizar</button>
        </div>
      </form>
    </div>
    <div>
      <h2>Log</h2>
      <button id="log-refresh" class="btn btn-primary mb-3" onclick="updateLog();">Actualizar</button>
      <div id="log-element" class="border p-3" style="white-space: pre-wrap;"></div>
    </div>
  </div>
  <!-- JavaScript -->
  <script>
    let currentFrequency = null;

    async function updateTuner() {
      try {
        const res = await fetch('/api/frequency', {
          method: 'GET',
          credentials: 'same-origin'
        });
        const data = await res.json();
        const frequency = data.frequency.replace('M', '');
        currentFrequency = parseFloat(frequency);
        document.getElementById('tuner-element').innerHTML = frequency;
        document.getElementById('change-freq').value = currentFrequency;
        document.getElementById('selected-frequency').innerHTML = frequency;
        document.getElementById('frequency-input').value = frequency + 'M';
        checkFrequencyChange();
      } catch (e) {
        console.error(e);
      }
    }

    async function updateRDS() {
    try {
      const res = await fetch('/api/rds');
      const data = await res.json();
      document.getElementById('rds-station').innerText = data['pi'] || '--';
      document.getElementById('rds-text').innerText = data['radiotext'] || '--';
    } catch (e) {
      console.error(e);
    }
  }

    function checkFrequencyChange() {
      const selectedFrequency = parseFloat(document.getElementById('change-freq').value);
      const tuneButton = document.getElementById('tune-button');
      if (selectedFrequency !== currentFrequency) {
        tuneButton.disabled = false;
      } else {
        tuneButton.disabled = true;
      }
    }

    // Actualizar la frecuencia mostrada mientras se mueve el slider
    document.getElementById('change-freq').addEventListener('input', function() {
      const freqValue = this.value;
      document.getElementById('selected-frequency').innerHTML = freqValue;
      document.getElementById('frequency-input').value = freqValue + 'M';
      checkFrequencyChange();
    });

    async function updateLog() {
      try {
        const res = await fetch('/api/procinfo', {
          method: 'GET',
          credentials: 'same-origin'
        });
        const data = await res.text();
        const elem = document.getElementById('log-element');
        elem.innerHTML = data.replace(/\n/g, '<br />');
      } catch (e) {
        console.error(e);
      }
    }

    // Inicializar
    updateTuner();
    updateRDS();
    updateLog();
  </script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>